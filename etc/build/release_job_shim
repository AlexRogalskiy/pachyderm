#!/bin/bash

version=`cat VERSION`

if [ -z $version ]
then
        echo "No version found for this commit! Aborting release"
        exit 1
fi

echo "--- Releasing job-shim w version: $version"

build_number=`echo $version | sed -En 's/(v[0-9]+\.[0-9]+\.[0-9]+)\((.*)\)/\2/p'`
docker_version=`echo $version | sed -e 's/[\(]/-/g' | sed -e 's/[\)]//g'`


TRAVIS_BUILD_NUMBER=$build_number make docker-push-job-shim
docker version pachyderm/job-shim:latest pachyderm/job-shim:$docker_version
docker push pachyderm/job-shim:$docker_version
