dist: xenial
sudo: required
cache:
  directories:
    # If any directories are added here, they must also be added to
    # etc/testing/travis_cache.sh
    - ${HOME}/.cache
    - ${HOME}/cached-deps
    - ${HOME}/gopath/pkg/mod
    - "$(python3 -c 'import site; print(site.USER_BASE)')"
    - ${HOME}/consistency-check

language: go
go:
  - "1.13.1"
env:
  global:
    - PATH="${HOME}/cached-deps:$(python3 -c 'import site; print(site.USER_BASE)')/bin:${PATH}"
    - PPS_BUCKETS=6
    - AUTH_BUCKETS=2
    - GOPROXY=https://proxy.golang.org
  matrix:
    - BUCKET=MISC
    # If you want to update the number of PPS or auth buckets, you'll neet to
    # update the value of PPS_BUCKETS or AUTH_BUCKETS above
    - BUCKET=ADMIN
    - BUCKET=AUTH1
    - BUCKET=AUTH2
    - BUCKET=PFS
    - BUCKET=PPS1
    - BUCKET=PPS2
    - BUCKET=PPS3
    - BUCKET=PPS4
    - BUCKET=PPS5
    - BUCKET=PPS6
    - BUCKET=EXAMPLES

stages:
  - build
  - test

jobs:
  include:
    - stage: build
      script: mkdir -p ${HOME}/consistency-check; git rev-parse HEAD > ${HOME}/consistency-check/${TRAVIS_BUILD_NUMBER}-build-time-commit; echo CONSISTENCY CHECK; git rev-parse HEAD; find ${HOME}/consistency-check; cat ${HOME}/consistency-check/${TRAVIS_BUILD_NUMBER}-build-time-commit
      # XXX Experiment(lukemarsden): put back ; etc/testing/travis_build.sh

before_install:
  - pwd
  - ls
  - git log |head -n 20
  - env |sort
  # Make sure cache dirs exist and are writable
  - etc/testing/travis_cache.sh

# XXX Experiment(lukemarsden) - uncomment the following to put back
#install:
#  - etc/testing/travis_install.sh
#  :-(

# XXX Experiment(lukemarsden) - replace true with etc/testing/travis.sh below to put back
script: echo CONSISTENCY CHECK; find ${HOME}/consistency-check; cat ${HOME}/consistency-check/${TRAVIS_BUILD_NUMBER}-build-time-commit; git rev-parse HEAD; if [ ! "$(git rev-parse HEAD)" == "$(cat ${HOME}/consistency-check/${TRAVIS_BUILD_NUMBER}-build-time-commit)" ]; then echo "CONSISTENCY CHECK FAILED, GIT REPO CHANGED UNDER OUR FEET BETWEEN BUILD AND TEST, BAILING; $(git rev-parse HEAD) != $(cat ${HOME}/consistency-check/${TRAVIS_BUILD_NUMBER}-build-time-commit)"; exit 1; else travis_retry bash -c 'timeout 9m true; status=$?; if [ "$status" -ne 0 ]; then etc/testing/kube_debug.sh; fi; exit $status'; fi

before_cache:
  # Make sure cache dirs have the necessary permissions for Travis to traverse
  # & copy them all elsewhere
  - etc/testing/travis_cache.sh

notifications:
  slack: pachyderm:qmSCZSX1Q2yWxc6DjNZZFLGd
branches:
  only:
  # Trigger only for PR's to master
  - master
  # Trigger CI tests for all release branches
  # Eg. 1.9.x, 1.10.x
  - /^\d+\.\d+\.x/
  # Trigger CI tests for all branches that end with "-ci-trigger"
  # ruby reg-ex except for things before/after "/"
  - /.*(?i:ci-trigger)$/
  # For all branches uncomment the line below or remove the "branches" section
  #- /.*/
