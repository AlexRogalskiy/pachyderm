#!/bin/sh

# This script builds the docker images described by the Dockerfiles in this repository.
# This script will always build the main Dockerfile into pachyderm/pachyderm.
# If PACHYDERM_IMAGE is set, the script will additionally build Dockerfile.${PACHYDERM_IMAGE} into pachyderm/${PACHYDERM_IMAGE}.

set -Ee

DIR="$(cd "$(dirname "${0}")/.." && pwd)"

docker build -t "pachyderm/pachyderm" "${DIR}"

if [ -n "${PACHYDERM_IMAGE}" ]; then
  docker run \
    -v "${DIR}/_tmp:/compile" \
    "pachyderm/pachyderm" \
    go build \
      -a \
      -installsuffix netgo \
      -tags netgo \
      -o "/compile/${PACHYDERM_IMAGE}" \
      "src/cmd/${PACHYDERM_IMAGE}/main.go"

  docker build \
    -t "pachyderm/${PACHYDERM_IMAGE}" \
    -f "${DIR}/Dockerfile.${PACHYDERM_IMAGE}" \
    "${DIR}"
fi
