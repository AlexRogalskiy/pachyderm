#!/bin/sh

set -Ee

DIR="$(cd "$(dirname "${0}")/.." && pwd)"

docker build -t "pachyderm/pachyderm" "${DIR}"

if [ -n "${PACHYDERM_IMAGE}" ]; then
  docker run \
    -v "${DIR}/_tmp:/compile" \
    "pachyderm/pachyderm" \
    go build \
      -a \
      -installsuffix netgo \
      -tags netgo \
      -o "/compile/${PACHYDERM_IMAGE}" \
      "src/cmd/${PACHYDERM_IMAGE}/main.go"

  docker build \
    -t "pachyderm/${PACHYDERM_IMAGE}" \
    -f "${DIR}/Dockerfile.${PACHYDERM_IMAGE}" \
    "${DIR}"
fi
