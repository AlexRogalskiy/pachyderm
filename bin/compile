#!/bin/sh

set -Ee

DIR="$(cd "$(dirname "${0}")/.." && pwd)"
cd "${DIR}"

if [ -z "${1}" ] || [ -z "${2}" ] || [ -z "${3}" ]; then
	echo "Usage: compile path/to/main.go name path/to/outdir" >&2
	exit 1
fi

MAIN_PATH="${1}"
BINARY_NAME="${2}"
OUT_DIR="${3}"

rm -rf "/tmp/build/${BINARY_NAME}"
mkdir -p "/tmp/build/${BINARY_NAME}"
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -compiler gc -installsuffix cgo -tags netgo -ldflags "-d -s -w" -o "/tmp/build/${BINARY_NAME}/${BINARY_NAME}" "${MAIN_PATH}"
mkdir -p "${OUT_DIR}/${BINARY_NAME}"
cp "/tmp/build/${BINARY_NAME}/${BINARY_NAME}" "${OUT_DIR}/${BINARY_NAME}/${BINARY_NAME}"
echo "${OUT_DIR}/${BINARY_NAME}"
ls -lh "${OUT_DIR}/${BINARY_NAME}"
