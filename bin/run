#!/bin/sh

# This script will run the given command in $@ on pachyderm/${PACHYDERM_IMAGE}, properly setting up all associated state.
# If PACHYDERM_IMAGE is not set, this will run pachyderm/pachyderm.

set -Ee

DIR="$(cd "$(dirname "${0}")" && pwd)"

"${DIR}/clean"
"${DIR}/setup"

if [ -z "${AWS_REGION}" ]; then
	export AWS_REGION="us-west-1"
fi

export PFS_DIR="/tmp/pfs/btrfs"
export PFS_HOST_VOLUME="${PFS_DIR}/global"
export PFS_LOCAL_VOLUME="${PFS_DIR}/global"
export PFS_BTRFS_ROOT="${PFS_DIR}/global"
sudo mkdir -p "${PFS_HOST_VOLUME}"

if [ -z "${NODOCKER}" ]; then
  "${DIR}/build"
  if [ -z "${PACHYDERM_IMAGE}" ]; then
    PACHYDERM_IMAGE="pachyderm"
  fi
  docker run \
    ${PACHYDERM_DOCKER_OPTS} \
    --privileged=true \
    --name "${PACHYDERM_IMAGE}" \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -v /:/host:ro \
    -v "${PFS_DIR}:${PFS_DIR}" \
    -e "PFS_DIR=${PFS_DIR}" \
    -e "PFS_HOST_VOLUME=${PFS_HOST_VOLUME}" \
    -e "PFS_LOCAL_VOLUME=${PFS_LOCAL_VOLUME}" \
    -e "PFS_BTRFS_ROOT=${PFS_BTRFS_ROOT}" \
    -e "AWS_REGION=${AWS_REGION}" \
    -e "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" \
    -e "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" \
    "pachyderm/${PACHYDERM_IMAGE}" \
      $@
else
  # TODO(pedge): i am sure this is not complete, and we should not need sudo for everything
  sudo -E PATH=${PATH} $@
  # $@
fi
